#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

echo "-----> Attempting to load, decrypt, and export EnvKey variables"

BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
BUILD_DIR=${1:-}
ENV_DIR=${3:-}

if [ -f $ENV_DIR/ENVKEY ]; then
  curl -s -o .ek_tmp_version https://raw.githubusercontent.com/envkey/envkey-source/master/version.txt
  ENVKEY_VERSION=$(cat .ek_tmp_version)
  rm .ek_tmp_version

  ENVKEY_URL="https://raw.githubusercontent.com/envkey/envkey-source/master/dist/envkey-source_${ENVKEY_VERSION}_linux_amd64.tar.gz"
  echo "Downloading envkey-source ${ENVKEY_VERSION} from ${ENVKEY_URL}" | indent
  curl -s -o envkey-source.tar.gz "${ENVKEY_URL}"
  mkdir ./bin
  tar zxf envkey-source.tar.gz ./bin/envkey-source

  echo "ENVKEY config var is set" | indent
  export "ENVKEY=$(cat $ENV_DIR/ENVKEY)"
  echo "EnvKey variables exported to subsequent buildpacks" | indent
  echo $(./bin/envkey-source) > $BP_DIR/export
  mkdir $BUILD_DIR/.profile.d
  echo $(./bin/envkey-source) > $BUILD_DIR/.profile.d/envkey.sh
  echo \\nexport PATH='$PATH':$(pwd)/bin >> $BUILD_DIR/.profile.d/envkey.sh
  echo "EnvKey variables exported to running application via .profile.d/envkey.sh" | indent
else
  echo "ENVKEY config var not set" | indent
  exit 1
fi
